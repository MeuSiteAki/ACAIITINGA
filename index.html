<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>A√ßaiteria Tropical</title>

  <!-- SweetAlert2 & QRCode -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <!-- Firebase (FireStore) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    // Config do seu projeto
    const firebaseConfig = {
      apiKey: "AIzaSyBHBcJHtU_o8tjsJCSoCsO665M3N72mF8g",
      authDomain: "meusiteaki2025.firebaseapp.com",
      projectId: "meusiteaki2025",
      storageBucket: "meusiteaki2025.firebasestorage.app",
      messagingSenderId: "1059720978927",
      appId: "1:1059720978927:web:c4e5fde24aa95672d0161a",
      measurementId: "G-KD8EDDRLWZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Salvar pedido na cole√ß√£o "pedidos"
    async function salvarPedido(pedido) {
      try {
        await addDoc(collection(db, "pedidos"), pedido);
        console.log("‚úÖ Pedido salvo no Firestore");
      } catch (e) {
        console.error("‚ùå Erro ao salvar pedido:", e);
      }
    }

    // Impress√£o autom√°tica: quando esta mesma p√°gina (ou um painel da loja) estiver aberta,
    // vai escutar novos documentos e imprimir
    const pedidosRef = collection(db, "pedidos");
    onSnapshot(pedidosRef, (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
          const pedido = change.doc.data();
          const html = `
            <div style="font-family:Arial,sans-serif;line-height:1.4">
              <h2>üçß Novo Pedido</h2>
              <p><strong>Cliente:</strong> ${pedido.cliente}</p>
              <p><strong>Telefone:</strong> ${pedido.telefone}</p>
              <p><strong>Endere√ßo:</strong> ${pedido.endereco}</p>
              <p><strong>Bairro:</strong> ${pedido.bairro}</p>
              <p><strong>Pagamento:</strong> ${pedido.pagamento}</p>
              ${pedido.observacoes ? `<p><strong>Obs. gerais:</strong> ${pedido.observacoes}</p>` : ""}
              <hr/>
              ${pedido.itens.map((i, idx) => `
                <div>
                  <strong>#${idx+1}</strong> ‚Äî Copo ${i.size}ml (${Number(i.price).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})})<br/>
                  Frutas: ${i.fruits?.join(', ') || '-'}<br/>
                  Ingredientes: ${i.ingredients?.join(', ') || '-'}<br/>
                  Cobertura: ${i.topping || '-'}<br/>
                  ${i.notes ? `Obs. item: ${i.notes}` : ''}
                </div>
                <hr/>
              `).join('')}
              <p><strong>Total:</strong> ${Number(pedido.total).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</p>
            </div>
          `;
          const w = window.open('', '_blank');
          w.document.write(html);
          w.document.close();
          w.focus();
          w.print();
        }
      });
    });

    // Disponibiliza no escopo global
    window.__db = db;
    window.__salvarPedido = salvarPedido;
  </script>

  <style>
    :root{
      --primary:#2ecc71; --primary-dark:#27ae60; --accent:#f1c40f; --danger:#e74c3c;
      --bg:#f6fff8; --text:#2d3142; --muted:#7786a5; --card:#ffffff; --shadow:0 8px 20px rgba(0,0,0,0.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#eaffea,var(--bg));color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:#fff;padding:16px 20px;box-shadow:var(--shadow);display:flex;align-items:center;gap:12px}
    .logo{width:54px;height:54px;border-radius:50%;background:#fff;color:var(--primary-dark);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:18px;letter-spacing:0.5px;box-shadow:0 8px 20px rgba(0,0,0,0.2)}
    .brand{font-size:20px;font-weight:800}
    .container{max-width:1024px;margin:20px auto;padding:0 16px 110px}

    .card{border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px;color:#fff}
    .theme-green{background:linear-gradient(135deg,#2ecc71,#27ae60)}
    .theme-blue{background:linear-gradient(135deg,#3498db,#2980b9)}
    .theme-purple{background:linear-gradient(135deg,#9b59b6,#8e44ad)}
    .theme-orange{background:linear-gradient(135deg,#f39c12,#d35400)}
    .theme-red{background:linear-gradient(135deg,#e74c3c,#c0392b)}
    .card h3{margin:0 0 10px}

    .sizes{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .size{background:#fff;color:#2d3142;border-radius:14px;padding:12px;text-align:center;font-weight:700;box-shadow:var(--shadow)}
    .size img{width:64px;height:64px;margin-bottom:6px;filter:drop-shadow(0 6px 10px rgba(0,0,0,0.15))}
    .size .sub{font-size:12px;color:#556}
    .size .price{margin-top:4px;color:#1b1f2a}
    .size input{margin-top:8px;width:26px;height:26px;accent-color:var(--primary)}

    .options{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
    .option{background:#fff;color:#2d3142;border-radius:12px;padding:10px;display:flex;align-items:center;gap:10px;font-weight:600;box-shadow:var(--shadow)}
    .option.disabled{opacity:.5;pointer-events:none}
    input[type=checkbox],input[type=radio]{width:26px;height:26px;accent-color:var(--primary);cursor:pointer}

    .input textarea,.input input,.input select{width:100%;border:2px solid #eaeef5;border-radius:10px;padding:10px;font-size:14px;outline:none;background:#fff;color:#2d3142}
    .input textarea:focus,.input input:focus,.input select:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(39,174,96,0.12)}

    .actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn{border:none;border-radius:999px;padding:12px 16px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:var(--shadow)}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.secondary{background:var(--accent);color:#3b2400}
    .btn.ghost{background:#fff;color:var(--primary-dark);border:2px solid #eee}

    .fab-cart{position:fixed;bottom:16px;right:16px;background:linear-gradient(135deg,var(--accent),#ffe58a);color:#3b2400;border-radius:999px;padding:14px 16px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 18px 35px rgba(0,0,0,0.18);font-weight:800;border:none;cursor:pointer;z-index:9}

    .cart-panel{position:fixed;top:0;right:0;width:min(460px,92vw);height:100vh;background:#ffffff;box-shadow:-12px 0 24px rgba(0,0,0,0.14);transform:translateX(105%);transition:transform .3s ease;z-index:10;display:grid;grid-template-rows:auto 1fr auto auto;border-left:6px solid var(--accent)}
    .cart-panel.open{transform:translateX(0)}
    .cart-header{padding:14px 16px;background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:#fff;display:flex;align-items:center;justify-content:space-between;font-weight:800}
    .cart-items{padding:14px;overflow:auto;display:grid;gap:12px;background:#f9fdf9}
    .cart-item{background:#fff;border:2px solid #eef1f5;border-radius:14px;padding:12px;box-shadow:var(--shadow);display:grid;gap:8px}
    .cart-item .top{display:flex;justify-content:space-between;align-items:center}
    .cart-title{font-weight:800;color:#1b1f2a}
    .cart-price{font-weight:800;color:#1b1f2a}
    .list-row{font-size:13px;color:#334}
    .remove{align-self:flex-end;background:#ffecec;border:1px solid #ffd0d0;color:var(--danger);border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
    .empty{text-align:center;color:var(--muted);padding:18px}
    .total-bar{background:#fff;padding:12px 16px;font-weight:800;text-align:right;border-top:2px solid #eef1f5}

    .form{padding:12px;display:grid;gap:10px}
    .label{font-size:12px;color:var(--muted);margin-bottom:4px}

    .toast{position:fixed;bottom:25px;left:50%;transform:translateX(-50%);background:#fff;padding:16px 22px;border-radius:14px;box-shadow:var(--shadow);font-size:18px;font-weight:700;border:2px solid var(--primary);animation:fadeInOut 2.5s ease forwards;z-index:50}
    @keyframes fadeInOut{0%{opacity:0;transform:translate(-50%,14px)}10%{opacity:1;transform:translate(-50%,0)}85%{opacity:1}100%{opacity:0;transform:translate(-50%,14px)}}

    @media(max-width:640px){.sizes{grid-template-columns:1fr 1fr}}
    @media(max-width:420px){.sizes{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="logo">AT</div>
    <div class="brand">A√ßaiteria Tropical</div>
  </header>

  <main class="container">
    <section class="card theme-green">
      <h3>Tamanho do copo</h3>
      <div class="sizes" id="sizeGroup">
        <label class="size">
          <img src="a√ßai.jpg" alt="Copo 300"/><br>
          300ml<br><span class="sub">2 frutas ‚Ä¢ 2 ingredientes ‚Ä¢ 1 cobertura</span>
          <div class="price"><strong>R$ 10,00</strong></div>
          <input type="radio" name="size" value="300" data-price="10">
        </label>
        <label class="size">
          <img src="a√ßai.jpg" alt="Copo 400"/><br>
          400ml<br><span class="sub">3 frutas ‚Ä¢ 3 ingredientes ‚Ä¢ 1 cobertura</span>
          <div class="price"><strong>R$ 15,00</strong></div>
          <input type="radio" name="size" value="400" data-price="15">
        </label>
        <label class="size">
          <img src="a√ßai.jpg" alt="Copo 500"/><br>
          500ml<br><span class="sub">4 frutas ‚Ä¢ 4 ingredientes ‚Ä¢ 1 cobertura</span>
          <div class="price"><strong>R$ 20,00</strong></div>
          <input type="radio" name="size" value="500" data-price="20">
        </label>
      </div>
    </section>

    <section class="card theme-blue">
      <h3>Frutas</h3>
      <div class="options" id="fruits"></div>
    </section>

    <section class="card theme-purple">
      <h3>Ingredientes</h3>
      <div class="options" id="ingredients"></div>
    </section>

    <section class="card theme-orange">
      <h3>Cobertura</h3>
      <div class="options" id="toppings"></div>
      <div class="input" style="margin-top:8px;">
        <span class="label">Opcional ‚Äî escolha se quiser.</span>
      </div>
    </section>

    <section class="card theme-red">
      <h3>Observa√ß√µes</h3>
      <div class="input">
        <textarea id="notes" rows="3" placeholder="Ex.: pouco xarope, sem granola, ponto do a√ßa√≠‚Ä¶ (opcional)"></textarea>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn primary" id="addToCart">Adicionar ao carrinho</button>
        <button class="btn ghost" id="reset">Limpar escolhas</button>
      </div>
    </section>
  </main>

  <button class="fab-cart" id="toggleCart">üõí Abrir carrinho</button>

  <aside class="cart-panel" id="cartPanel">
    <div class="cart-header">
      <strong>Seu carrinho</strong>
      <button class="btn secondary" id="closeCart">Fechar</button>
    </div>

    <div class="cart-items" id="cartItems">
      <div class="empty">Seu carrinho est√° vazio. Adicione um a√ßa√≠ para come√ßar. üíö</div>
    </div>

    <div class="total-bar" id="totalBar">Total: R$ 0,00</div>

    <div class="form">
      <div class="input"><span class="label">Nome</span><input id="name" type="text" placeholder="Seu nome" required></div>
      <div class="input"><span class="label">Telefone</span><input id="phone" type="tel" placeholder="(99) 9 9999-9999" required></div>
      <div class="input"><span class="label">Endere√ßo</span><input id="address" type="text" placeholder="Rua, n√∫mero" required></div>
      <div class="input"><span class="label">Bairro</span><input id="neighborhood" type="text" placeholder="Bairro" required></div>
      <div class="input">
        <span class="label">Forma de pagamento</span>
        <select id="payment" required>
          <option value="" selected disabled>Selecione</option>
          <option>Dinheiro</option>
          <option>Cart√£o</option>
          <option>Pix</option>
        </select>
      </div>
      <div class="actions" style="justify-content:flex-end;">
        <button class="btn primary" id="sendWhatsapp">üì≤ Enviar pedido no WhatsApp</button>
      </div>
      <div class="label" style="text-align:right;">Envio para: 55 99 9224-7544</div>
    </div>
  </aside>

  <footer style="text-align:center;color:var(--muted);padding:20px 16px 90px;">
    ¬© 2025 A√ßaiteria Tropical ‚Äî Feito com üíö em Imperatriz, MA.
  </footer>

  <script>
    // Dados
    const FRUITS = ["Banana","Morango","Manga","Kiwi","Uva","Abacaxi"];
    const INGREDIENTS = ["Granola","Leite em p√≥","Pa√ßoca","Amendoim","Jujuba","Castanha"];
    const TOPPINGS = ["Chocolate","Caramelo","Leite condensado","Morango"];

    // √çcones apenas no toast
    const EMOJI = {
      Banana:"üçå", Morango:"üçì", Manga:"ü•≠", Kiwi:"ü•ù", Uva:"üçá", Abacaxi:"üçç",
      Granola:"ü•£", "Leite em p√≥":"ü•õ", Pa√ßoca:"ü•ú", Amendoim:"ü•ú", Jujuba:"üç¨", Castanha:"üå∞"
    };

    // PIX Config
    const PIX_KEY = '+5599992247544';
    const PIX_NAME = 'Carlos de Freitas Rocha';
    const PIX_BANK = 'Banco do Brasil';
    const PIX_CITY = 'IMPERATRIZ';

    // Elementos
    const sizeRadios = document.querySelectorAll('input[name="size"]');
    const fruitsWrap = document.getElementById('fruits');
    const ingredientsWrap = document.getElementById('ingredients');
    const toppingsWrap = document.getElementById('toppings');

    const addToCartBtn = document.getElementById('addToCart');
    const resetBtn = document.getElementById('reset');

    const cartPanel = document.getElementById('cartPanel');
    const toggleCartBtn = document.getElementById('toggleCart');
    const closeCartBtn = document.getElementById('closeCart');
    const cartItems = document.getElementById('cartItems');
    const totalBar = document.getElementById('totalBar');

    const nameInput = document.getElementById('name');
    const phoneInput = document.getElementById('phone');
    const addressInput = document.getElementById('address');
    const neighborhoodInput = document.getElementById('neighborhood');
    const paymentInput = document.getElementById('payment');
    const sendWhatsappBtn = document.getElementById('sendWhatsapp');

    // Estado
    let limits = { fruits: 0, ingredients: 0 };
    let cart = [];

    // Render options
    function createOption(labelText, name, type = "checkbox") {
      const d = document.createElement('label');
      d.className = 'option';
      d.innerHTML = `<input type="${type}" name="${name}" value="${labelText}">${labelText}`;
      return d;
    }
    FRUITS.forEach(f => fruitsWrap.appendChild(createOption(f, 'fruits')));
    INGREDIENTS.forEach(i => ingredientsWrap.appendChild(createOption(i, 'ingredients')));
    TOPPINGS.forEach(t => toppingsWrap.appendChild(createOption(t, 'toppings', 'radio')));

    // Nenhum radio marcado ao abrir
    sizeRadios.forEach(r => r.checked = false);
    toppingsWrap.querySelectorAll('input[name="toppings"]').forEach(t => t.checked = false);

    // Limites por tamanho (apenas para desabilitar al√©m do m√°ximo; sele√ß√£o √© opcional)
    function updateLimitsFromSize() {
      const selected = document.querySelector('input[name="size"]:checked')?.value;
      if (selected === '300') limits = { fruits: 2, ingredients: 2 };
      else if (selected === '400') limits = { fruits: 3, ingredients: 3 };
      else if (selected === '500') limits = { fruits: 4, ingredients: 4 };
      else limits = { fruits: 0, ingredients: 0 };
      enforceLimits('fruits', limits.fruits);
      enforceLimits('ingredients', limits.ingredients);
    }

    sizeRadios.forEach(r => r.addEventListener('change', () => {
      resetSelections(true);
      r.checked = true;
      updateLimitsFromSize();
    }));
    updateLimitsFromSize();

    function enforceLimits(groupName, max) {
      const inputs = document.querySelectorAll(`input[name="${groupName}"]`);
      const selectedCount = Array.from(inputs).filter(i => i.checked).length;
      inputs.forEach(i => {
        if (max === 0) {
          i.closest('.option').classList.add('disabled');
          i.checked = false;
        } else {
          if (!i.checked) i.closest('.option').classList.toggle('disabled', selectedCount >= max);
          else i.closest('.option').classList.remove('disabled');
        }
      });
    }

    function showToast(text, emoji = '') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = `${emoji ? emoji + ' ' : ''}${text} adicionado`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    ['fruits','ingredients'].forEach(group => {
      document.querySelectorAll(`input[name="${group}"]`).forEach(inp => {
        inp.addEventListener('change', () => {
          const max = group === 'fruits' ? limits.fruits : limits.ingredients;
          const inputs = document.querySelectorAll(`input[name="${group}"]`);
          const count = Array.from(inputs).filter(i => i.checked).length;
          if (count > max) {
            inp.checked = false;
          } else if (inp.checked) {
            const emoji = EMOJI[inp.value] || '';
            showToast(inp.value, emoji);
          }
          enforceLimits(group, max);
        });
      });
    });

    function openCart(){cartPanel.classList.add('open');toggleCartBtn.textContent='üõí Fechar carrinho'}
    function closeCart(){cartPanel.classList.remove('open');toggleCartBtn.textContent='üõí Abrir carrinho'}
    toggleCartBtn.addEventListener('click',()=>cartPanel.classList.contains('open')?closeCart():openCart());
    closeCartBtn.addEventListener('click',closeCart);

    addToCartBtn.addEventListener('click', () => {
      const sizeInput = document.querySelector('input[name="size"]:checked');
      const size = sizeInput?.value;
      const price = Number(sizeInput?.dataset?.price || 0);
      const fruits = Array.from(document.querySelectorAll('input[name="fruits"]:checked')).map(i => i.value);
      const ingredients = Array.from(document.querySelectorAll('input[name="ingredients"]:checked')).map(i => i.value);
      const topping = document.querySelector('input[name="toppings"]:checked')?.value || '';
      const notes = document.getElementById('notes').value.trim();

      if (!size) return alert('Escolha um tamanho.');

      const item = { id: Date.now(), size, price, fruits, ingredients, topping, notes };
      cart.push(item);
      renderCart();
      openCart();
      showToast(`Copo ${size}ml`);
      resetSelections(false);
    });

    function resetSelections(full = true) {
      ['fruits','ingredients'].forEach(group => {
        document.querySelectorAll(`input[name="${group}"]`).forEach(i => i.checked = false);
        enforceLimits(group, limits[group]);
      });
      if (full) {
        document.querySelectorAll('input[name="size"]').forEach(r => r.checked = false);
        document.querySelectorAll('input[name="toppings"]').forEach(t => t.checked = false);
        updateLimitsFromSize();
      }
      document.getElementById('notes').value = '';
    }
    resetBtn.addEventListener('click',()=>resetSelections(true));

    function formatBRL(n){return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
    function renderCart(){
      cartItems.innerHTML='';
      if(cart.length===0){
        cartItems.innerHTML='<div class="empty">Seu carrinho est√° vazio. Adicione um a√ßa√≠ para come√ßar. üíö</div>';
        updateTotalBar(); return;
      }
      cart.forEach(item=>{
        const div=document.createElement('div');
        div.className='cart-item';
        div.innerHTML=`
          <div class="top">
            <div class="cart-title">Copo ${item.size}ml</div>
            <div class="cart-price">${formatBRL(item.price)}</div>
          </div>
          <div class="list-row"><strong>Frutas:</strong> ${item.fruits.join(', ') || '-'}</div>
          <div class="list-row"><strong>Ingredientes:</strong> ${item.ingredients.join(', ') || '-'}</div>
          <div class="list-row"><strong>Cobertura:</strong> ${item.topping || '-'}</div>
          ${item.notes ? `<div class="list-row"><strong>Obs.:</strong> ${item.notes}</div>` : ''}
          <button class="remove" data-id="${item.id}">Remover</button>
        `;
        cartItems.appendChild(div);
      });
      cartItems.querySelectorAll('.remove').forEach(btn=>{
        btn.addEventListener('click',e=>{
          const id=Number(e.currentTarget.getAttribute('data-id'));
          cart=cart.filter(i=>i.id!==id);
          renderCart();
        });
      });
      updateTotalBar();
    }
    function updateTotalBar(){
      const total=cart.reduce((s,i)=>s+i.price,0);
      totalBar.textContent=`Total: ${formatBRL(total)}`;
      sendWhatsappBtn.disabled=cart.length===0;
    }

    phoneInput.addEventListener('input',()=>{
      let v=phoneInput.value.replace(/\D/g,'');
      v=v.replace(/^(\d{2})(\d)/,'($1) $2').replace(/(\d{5})(\d)/,'$1-$2');
      phoneInput.value=v.slice(0,15);
    });

    paymentInput.addEventListener('change',async ()=>{
      const total=cart.reduce((sum,i)=>sum+i.price,0);
      const val=paymentInput.value;

      if(val==='Pix'){
        if(total<=0){
          await Swal.fire({icon:'info',title:'Carrinho vazio',text:'Adicione itens para gerar o Pix.'});
          paymentInput.value='';return;
        }
        const code=buildPixBRCode({key:PIX_KEY,name:PIX_NAME,city:PIX_CITY,amount:total,txid:'ACAI'});
        const canvas=document.createElement('canvas');
        await QRCode.toCanvas(canvas,code,{width:220});
        const dataUrl=canvas.toDataURL();

        Swal.fire({
          title:'Pagamento via Pix',
          html:`
            <div style="display:grid;gap:12px;place-items:center">
              <img src="${dataUrl}" alt="QR Pix" style="width:220px;height:220px;border:1px solid #eee;border-radius:8px"/>
              <div style="display:flex;gap:8px;width:100%;">
                <textarea id="pixCodeTA" readonly style="flex:1;height:100px;font-size:12px;">${code}</textarea>
                <button id="copyPixBtn" class="swal2-confirm swal2-styled" style="background:#2ecc71;white-space:nowrap;">Copiar</button>
              </div>
              <small style="color:#7786a5">Copie o c√≥digo de pagamento e cole no seu app do banco.</small>
            </div>
          `,
          width:520,
          showConfirmButton:false,
          didOpen:()=>{
            const btn=document.getElementById('copyPixBtn');
            btn?.addEventListener('click',async()=>{
              const ta=document.getElementById('pixCodeTA');
              await navigator.clipboard.writeText(ta.value);
              Swal.fire({toast:true,position:'top',icon:'success',title:'C√≥digo Pix copiado',showConfirmButton:false,timer:1800});
            });
          }
        });
      }

      if(val==='Dinheiro'){
        if(total<=0){
          await Swal.fire({icon:'info',title:'Carrinho vazio',text:'Adicione itens para calcular o troco.'});
          paymentInput.value='';return;
        }
        const {value:cash}=await Swal.fire({
          title:'Valor em dinheiro',
          input:'number',
          inputLabel:`Total: ${formatBRL(total)} ‚Äî informe o valor entregue`,
          inputAttributes:{step:'0.01',min:String(total)},
          confirmButtonText:'Calcular troco',
          showCancelButton:true
        });
        if(cash!==undefined&&cash!==null&&cash!==''){
          const value=parseFloat(cash);
          if(isNaN(value)||value<total){
            await Swal.fire({icon:'warning',title:'Valor insuficiente',text:'O valor entregue √© menor que o total.'});
            paymentInput.value='';return;
          }
          const troco=value-total;
          const notesEl=document.getElementById('notes');
          const prefix=notesEl.value.trim()?notesEl.value.trim()+' | ':'';
          notesEl.value=`${prefix}Troco para: ${formatBRL(value)} (troco: ${formatBRL(troco)})`;
          await Swal.fire({icon:'success',title:'Troco calculado',text:`Troco: ${formatBRL(troco)}. Observa√ß√£o atualizada.`});
        } else {
          paymentInput.value='';
        }
      }
    });

    // WhatsApp + Firestore
    sendWhatsappBtn.addEventListener('click',()=>{
      if(cart.length===0)return alert('Adicione pelo menos um a√ßa√≠ ao carrinho.');
      if(!nameInput.value.trim())return alert('Informe seu nome.');
      if(!phoneInput.value.trim())return alert('Informe seu telefone.');
      if(!addressInput.value.trim())return alert('Informe seu endere√ßo.');
      if(!neighborhoodInput.value.trim())return alert('Informe seu bairro.');
      if(!paymentInput.value)return alert('Selecione a forma de pagamento.');

      const total=cart.reduce((sum,i)=>sum+i.price,0);

      const itemsText=cart.map((item,idx)=>[
        `#${idx+1}`,
        `‚Ä¢ Copo: ${item.size}ml`,
        `‚Ä¢ Pre√ßo: ${formatBRL(item.price)}`,
        `‚Ä¢ Frutas: ${item.fruits.join(', ')||'-'}`,
        `‚Ä¢ Ingredientes: ${item.ingredients.join(', ')||'-'}`,
        `‚Ä¢ Cobertura: ${item.topping||'-'}`,
        item.notes?`‚Ä¢ Observa√ß√µes do item: ${item.notes}`:null
      ].filter(Boolean).join('\n')).join('\n\n');

      const customerFields=[
        `Cliente: ${nameInput.value.trim()}`,
        `Telefone: ${phoneInput.value.trim()}`,
        `Endere√ßo: ${addressInput.value.trim()}`,
        `Bairro: ${neighborhoodInput.value.trim()}`,
        `Pagamento: ${paymentInput.value}`
      ].join('\n');

      const extraObs = document.getElementById('notes').value.trim()
        ? `\nObserva√ß√µes gerais: ${document.getElementById('notes').value.trim()}`
        : '';

      const message=[
        'üçß Pedido ‚Äî A√ßaiteria Tropical',
        '==============================',
        itemsText,
        '==============================',
        `Total: ${formatBRL(total)}`,
        '',
        customerFields + extraObs
      ].join('\n');

      const phone='559992247544';
      const url=`https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
      window.open(url,'_blank');

      // Salvar no Firestore
      const pedido = {
        cliente: nameInput.value.trim(),
        telefone: phoneInput.value.trim(),
        endereco: addressInput.value.trim(),
        bairro: neighborhoodInput.value.trim(),
        pagamento: paymentInput.value,
        observacoes: document.getElementById('notes').value.trim(),
        itens: cart,
        total,
        data: new Date().toISOString()
      };
      window.__salvarPedido?.(pedido);

      // Atualiza a p√°gina automaticamente ap√≥s enviar
      setTimeout(()=>location.reload(),1000);
    });

    // Helpers: Pix BR Code (EMV)
    function buildPixBRCode({key,name,city,amount,txid='ACAI'}){
      const tlv=(id,value)=>id+String(value.length).padStart(2,'0')+value;
      const gui=tlv('00','BR.GOV.BCB.PIX');
      const mAccountInfo=tlv('26',gui+tlv('01',key));
      const mc=tlv('52','0000');
      const cur=tlv('53','986');
      const amt=tlv('54',Number(amount).toFixed(2));
      const cc=tlv('58','BR');
      const nm=tlv('59',(name||'').slice(0,25));
      const ct=tlv('60',(city||'').slice(0,15));
      const add=tlv('62',tlv('05',(txid||'').slice(0,25)));
      const pfi=tlv('00','01');
      const poi=tlv('01','12');
      let payload=pfi+poi+mAccountInfo+mc+cur+amt+cc+nm+ct+add;
      payload+='63'+'04';
      const crc=crc16(payload);
      payload+=crc;
      return payload;
    }
    function crc16(payload){
      let crc=0xFFFF;const poly=0x1021;
      const bytes=new TextEncoder().encode(payload);
      for(let b of bytes){crc^=(b<<8);for(let i=0;i<8;i++){if(crc&0x8000){crc=(crc<<1)^poly}else{crc=(crc<<1)}crc&=0xFFFF}}
      return crc.toString(16).toUpperCase().padStart(4,'0');
    }
  </script>
</body>
</html>
